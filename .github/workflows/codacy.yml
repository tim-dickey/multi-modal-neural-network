name: Codacy Analysis

on:
  push:
    branches:
      - main
      - '**'
  pull_request:
    branches:
      - main

jobs:
  codacy-analysis:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for Codacy token
        env:
          CODACY_PROJECT_TOKEN: ${{ secrets.CODACY_PROJECT_TOKEN }}
        run: |
          if [ -z "${CODACY_PROJECT_TOKEN:-}" ]; then
            echo "CODACY_PROJECT_TOKEN not set; skipping Codacy analysis"
            exit 0
          fi

      - name: Download Codacy CLI (bootstrap)
        run: |
          chmod +x ./.codacy/cli.sh || true
          bash ./.codacy/cli.sh download
          echo "--- DIAG: post-download (cwd=$(pwd)) ---" > codacy-diag.txt
          echo "pwd: $(pwd)" >> codacy-diag.txt
          echo "ls -la .codacy-cli-v2:" >> codacy-diag.txt
          ls -la .codacy-cli-v2 >> codacy-diag.txt 2>&1 || true
          echo "ls -la .codacy:" >> codacy-diag.txt
          ls -la .codacy >> codacy-diag.txt 2>&1 || true
          echo "ls -la ~/.cache/codacy (if present):" >> codacy-diag.txt
          ls -la ~/.cache/codacy >> codacy-diag.txt 2>&1 || true

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run Codacy analysis (local bootstrap)
        env:
          CODACY_PROJECT_TOKEN: ${{ secrets.CODACY_PROJECT_TOKEN }}
        run: |
          echo "--- DIAG: before analyze (cwd=$(pwd)) ---" >> codacy-diag.txt
          echo "whoami: $(whoami)" >> codacy-diag.txt
          echo "pwd: $(pwd)" >> codacy-diag.txt
          echo "ls -la (repo root):" >> codacy-diag.txt
          ls -la >> codacy-diag.txt 2>&1 || true

          # Ensure the bootstrap is executable and download the CLI into the cache
          chmod +x ./.codacy/cli.sh || true
          echo "--- running bootstrap download (bash -x) ---" >> codacy-diag.txt
          bash -x ./.codacy/cli.sh download >> codacy-diag.txt 2>&1 || true

          # Locate the extracted binary in the cache
          cache="$HOME/.cache/codacy/codacy-cli-v2"
          version="$(awk -F'"' '/version:/ {print $2; exit}' "$cache/version.yaml" 2>/dev/null || true)"
          BIN=""
          if [ -n "$version" ] && [ -f "$cache/$version/codacy-cli-v2" ]; then
            BIN="$cache/$version/codacy-cli-v2"
          else
            BIN="$(find "$cache" -maxdepth 3 -type f -name codacy-cli-v2 | head -n1 || true)"
          fi

          echo "Binary candidate: $BIN" >> codacy-diag.txt
          if [ -z "$BIN" ] || [ ! -f "$BIN" ]; then
            echo "Binary not found; listing cache:" >> codacy-diag.txt
            ls -la "$cache" >> codacy-diag.txt 2>&1 || true
            echo "Binary not found; failing" >> codacy-diag.txt
            exit 1
          fi

          ls -la "$BIN" >> codacy-diag.txt 2>&1 || true
          stat "$BIN" >> codacy-diag.txt 2>&1 || true
          chmod +x "$BIN" || true

          echo "--- executing extracted binary directly ---" >> codacy-diag.txt
          # Execute the extracted binary directly; quote the token to avoid shell interpretation
          "$BIN" analyze --project-token "$CODACY_PROJECT_TOKEN" --directory . 2>&1 | tee codacy-cli.log

          # Append diagnostics to the log bundle
          echo "\n--- CONTENTS OF codacy-diag.txt ---" >> codacy-cli.log
          cat codacy-diag.txt >> codacy-cli.log || true

      - name: Upload Codacy CLI output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: codacy-cli-output
          path: |
            codacy-cli.log
            codacy-diag.txt
            .codacy-cli-v2
            .codacy

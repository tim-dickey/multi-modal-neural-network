name: Codacy Analysis

on:
  push:
    branches:
      - main
      - '**'
  pull_request:
    branches:
      - main

jobs:
  codacy-analysis:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for Codacy token
        env:
          CODACY_PROJECT_TOKEN: ${{ secrets.CODACY_PROJECT_TOKEN }}
        run: |
          if [ -z "${CODACY_PROJECT_TOKEN:-}" ]; then
            echo "CODACY_PROJECT_TOKEN not set; skipping Codacy analysis"
            exit 0
          fi

      - name: Download Codacy CLI (bootstrap)
        run: |
          chmod +x ./.codacy/cli.sh || true
          bash ./.codacy/cli.sh download

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run Codacy analysis (local bootstrap)
        env:
          CODACY_PROJECT_TOKEN: ${{ secrets.CODACY_PROJECT_TOKEN }}
        run: |
          # Capture stdout/stderr to a log file for later inspection
          bash ./.codacy/cli.sh analyze --project-token "$CODACY_PROJECT_TOKEN" --directory . 2>&1 | tee codacy-cli.log

      - name: Upload Codacy CLI output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: codacy-cli-output
          path: |
            codacy-cli.log
            .codacy-cli-v2
            .codacy
